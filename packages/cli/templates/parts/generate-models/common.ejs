<?php

use PromCMS\Core\Database\Model;
use PromCMS\Core\Database\SingletonModel;
use PromCMS\Core\Database\ModelResult;
<% if (events.beforeSave.slugify) { %>use Illuminate\Support\Str;<% } %>

<%# TODO: user soft deletes %> 
class <%- modelName %> extends <%- isSingleton ? "SingletonModel" : "Model" %>
{
  <% if (isSingleton) { %>
    protected string $name = '<%- name %>';
  <% } else { %>
    protected string $tableName = '<%- tableName %>';
    protected bool $softDelete = <%- typeof softDelete !== 'undefined' && softDelete ? 'true' : 'false' %>;
  <% } %>
  protected bool $timestamps = <%- timestamp ? 'true' : 'false' %>;
  protected bool $translations = <%- intl ? 'true' : 'false' %>;

  <%# Column casts %> 
  <% if (columnCasts.length) { %>
  public static array $casts = [
    <% columnCasts.forEach(([columnKey, castTo]) => { %>
      '<%- columnKey %>' => '<%- castTo %>',
    <%  });%> 
  ];
  <% } %>

  <%# Table columns info %> 
  public static array $tableColumns = [
    <% 
      Object.keys(formattedColumns).forEach(columnKey => { 
      const formattedColumnSettings = formattedColumns[columnKey];
    %>
      '<%- columnKey %>' => [
        <%- formattedColumnSettings.join(', ') %>
      ],
    <% }) %>
  ];
  
  <%# Custom model info not tied to PromCMS\Core\Database\Model perse %> 
  static bool $ignoreSeeding = <%- ignoreSeeding ? 'true' : 'false' %>;
  static string $modelIcon = '<%- icon %>';
  static $adminSettings = [];

  <%# Listeners #%> 
  <% if (events.shouldInclude()) { %>
      <%# after created #%>
      <% if (events.afterCreated.shouldInclude()) { %>
        public static function afterCreate(ModelResult $entry): ModelResult {
          <%# Copy ids when ordering #%>
          <% if (events.afterCreated.ordering) { %>
            $entry->update(['order' => $entry->id]);

            return $entry;
          <% } %>
        }
      <% } %>

      <%# Before save #%>
      <% if (events.beforeSave.shouldInclude()) { %>
        public static function beforeCreate($entry): array {
          <%# Slugify fields #%>
          <% if (events.beforeSave.slugify) { %>
            foreach (
              array_filter(static::$tableColumns, function ($col) {
                return $col['type'] === 'slug';
              })
              as $colKey => $col
            ) {
              if (isset($entry[$col['of']]) && $entry[$col['of']]) {
                $entry[$colKey] = Str::slug($entry[$col['of']]);
              }
            }
          <% } %>

          return $entry;
        }
      <% } %>
  <% } %>

  <%# Getter of private and all relevant info #%>
  public function getSummary()
  {
    return (object) [
      'isSingleton'     => $this instanceof SingletonModel,
      <% if (isSingleton) { %> 'name'            => $this->getName(), <% } else { %> 'tableName'       => $this->getTableName(), <% } %>
      'icon'            => self::$modelIcon,
      'ignoreSeeding'   => self::$ignoreSeeding,
      'admin'           => self::$adminSettings,
      'columns'         => static::$tableColumns,
      'hasTimestamps'   => $this->hasTimestamps(),
      'hasSoftDelete'   => $this->hasSoftDelete(),
      'ownable'         => <%- !isSingleton && ownable ? 'true' : 'false' %>,
      'hasOrdering'     => <%- !isSingleton && sorting ? 'true' : 'false' %>,
      'isDraftable'     => <%- !isSingleton && draftable ? 'true' : 'false' %>,
      'isSharable'      => <%- !isSingleton && sharable ? 'true' : 'false' %>,
    ];
  }
}