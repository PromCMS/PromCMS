<?php

require __DIR__ . '/utils/utils.php';

use App\Twig\Extensions\AppExtension;
use PromCMS\Core\Path;
use PromCMS\Core\Utils;
use Slim\App;
use Slim\Views\Twig;

return function (App $app) {
  // get container
  /** @var \DI\Container $container */
  $container = $app->getContainer();
  $twig = $container->get(Twig::class);

  Utils::autoloadFolder(Path::join(__DIR__, 'Services'));
  Utils::autoloadFolder(Path::join(__DIR__, 'Http', 'Middleware'));
  Utils::autoloadFolder(Path::join(__DIR__, 'rendering', 'TwigExtensions'));

  /**
   * This generates mysql search params
   */
  function onlyOwnersOrEditors(int $ownerId, $classInstance)
  {
    return !$classInstance->getSummary()->isSharable
      ? ['created_by', '=', $ownerId]
      : [
        ['created_by', '=', $ownerId],
        'OR',
        ["coeditors.$ownerId", '=', true],
      ];
  }

  $container->set('password-service', new \App\Services\Password());
  $container->set('jwt-service', new \App\Services\JWT($container));
  $container->set('image-service', new \App\Services\ImageService($container));
  $container->set('file-service', new \App\Services\FileService($container));
  $container->set(
    'localization-service',
    new \App\Services\Localization($container),
  );

  // Add twig app extension
  $twig->addExtension(new AppExtension($container));
};
