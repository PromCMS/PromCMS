<?php
/** @var Router $router */
use Slim\Routing\RouteCollectorProxy as Router;
use App\Middleware\Auth as AuthMiddleware;
use App\Middleware\Permission as PermissionMiddleware;

$auth = new AuthMiddleware($app->getContainer());
$permissionMiddleware = new PermissionMiddleware($app->getContainer());

// Languages
$router->get('/locales/{lang}.json', '\App\Controllers\Localization:getLocalization',);

// Profile
$router->group('/profile', function (Router $innerRouter) use ($auth) {
  $innerRouter->   get('/request-password-reset', '\App\Controllers\UserProfile:requestPasswordReset',);
  $innerRouter->   get('/request-email-change', '\App\Controllers\UserProfile:requestEmailChange');
  $innerRouter->  post('/finalize-password-reset', '\App\Controllers\UserProfile:finalizePasswordReset',);
  $innerRouter->  post('/finalize-email-change', '\App\Controllers\UserProfile:finalizeEmailChange',);
  $innerRouter->  post('/login', '\App\Controllers\UserProfile:login');
  
  $innerRouter->group('',  function (Router $innerRouter) {
    $innerRouter-> get('/me', '\App\Controllers\UserProfile:getCurrent');
    $innerRouter-> get('/logout', '\App\Controllers\UserProfile:logout');
    $innerRouter->post('/update', '\App\Controllers\UserProfile:update');
  })->add($auth);
}); 

$router->group('/entry-types', function (Router $innerRouter) use ($auth, $permissionMiddleware) {
  // get info about all of models
  $innerRouter->get('', 'App\Controllers\EntryTypes:getInfo')->add($auth);

  // Folders
  $innerRouter->group('/folders', function (Router $innerRouter) use ($auth) {
    $innerRouter->   get('', '\App\Controllers\Folders:get')->add($auth);
    $innerRouter->  post('', '\App\Controllers\Folders:create')->add($auth);
    $innerRouter->delete('', '\App\Controllers\Folders:delete')->add($auth);
  });

  // Files
  $innerRouter->group('/files', function (Router $innerRouter) use ($auth) {
    $innerRouter->get('/paged-items', '\App\Controllers\Files:getManyListed')->add($auth);

    $innerRouter->group('/items', function (Router $innerRouter) use ($auth) {
      $innerRouter-> get('', '\App\Controllers\Files:getMany')->add($auth);
      $innerRouter->post('/create', '\App\Controllers\Files:create')->add($auth);

      $innerRouter->group('/{itemId}', function (Router $innerRouter) use (
        $auth
      ) {
        $innerRouter->   get('/raw', '\App\Controllers\Files:getFile');
        $innerRouter->   get('', '\App\Controllers\Files:get')->add($auth);
        $innerRouter-> patch('', '\App\Controllers\Files:update')->add($auth);
        $innerRouter->delete('', '\App\Controllers\Files:delete')->add($auth);
      });
    });
  });

  // Users
  $innerRouter->group('/users', function (Router $innerRouter) {
    $innerRouter->get('', '\App\Controllers\Users:getInfo');

    $innerRouter->group('/items', function (Router $innerRouter) {
      $innerRouter-> get('', '\App\Controllers\Users:getMany');
      $innerRouter->post('/create', '\App\Controllers\Users:create');

      $innerRouter->group('/{itemId}', function (Router $innerRouter) {
        $innerRouter->   get('', '\App\Controllers\Users:getOne');
        $innerRouter-> patch('', '\App\Controllers\Users:update');
        $innerRouter->delete('', '\App\Controllers\Users:delete');

        $innerRouter->get('/block', '\App\Controllers\Users:block');
        $innerRouter->get('/unblock', '\App\Controllers\Users:unblock');
        $innerRouter->get('/request-password-reset', '\App\Controllers\Users:requestPasswordReset');
      });
    });
  })->add($permissionMiddleware)->add($auth);

  // Other 
  $innerRouter->group('/{modelId}', function (Router $innerRouter) use ($auth) {
    $innerRouter->get('', '\App\Controllers\EntryType:getInfo')->add($auth);

    $innerRouter->group('/items', function (Router $innerRouter) use ($auth) {
      $innerRouter-> get('', '\App\Controllers\EntryType:getMany');
      $innerRouter->post('/reorder', '\App\Controllers\EntryType:swapTwo')->add($auth);
      $innerRouter->post('/create', '\App\Controllers\EntryType:create')->add($auth);

      $innerRouter->group('/{itemId}', function (Router $innerRouter) use ($auth) {
        $innerRouter->   get('', '\App\Controllers\EntryType:getOne');
        $innerRouter-> patch('', '\App\Controllers\EntryType:update')->add($auth);
        $innerRouter->delete('', '\App\Controllers\EntryType:delete')->add($auth);
      });
    });
  });
});
